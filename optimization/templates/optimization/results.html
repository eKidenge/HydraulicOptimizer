{% load dict_extras %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Optimization Results</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f9f9f9;
      color: #333;
    }
    h2, h3, h4 {
      color: #222;
      margin-top: 40px;
      margin-bottom: 15px;
    }
    .table-container, .chart-container {
      overflow-x: auto;
      background: #fff;
      padding: 15px 10px;
      margin-bottom: 30px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      border-radius: 6px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 600px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px 15px;
      text-align: right;
      vertical-align: middle;
      font-size: 0.95rem;
    }
    th {
      background-color: #eee;
      font-weight: 600;
    }
    td:first-child {
      text-align: left;
      font-weight: 500;
    }
    a {
      margin-top: 40px;
      display: inline-block;
      text-decoration: none;
      color: #007BFF;
      font-weight: 600;
      font-size: 1rem;
      transition: color 0.3s ease;
    }
    a:hover {
      color: #0056b3;
    }
    img {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 20px 0 40px 0;
      border: 1px solid #ddd;
      padding: 6px;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      border-radius: 6px;
    }
    ul {
      background: #fff;
      padding: 15px 20px;
      list-style: square inside;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      border-radius: 6px;
      font-size: 1rem;
      line-height: 1.5;
      max-width: 600px;
    }
    ul li {
      margin-bottom: 8px;
    }
    
    /* Algorithm tabs styling */
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #ddd;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      background: #f1f1f1;
      border: 1px solid #ddd;
      border-bottom: none;
      margin-right: 5px;
      border-radius: 5px 5px 0 0;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .tab:hover {
      background: #e9e9e9;
    }
    .tab.active {
      background: #fff;
      border-bottom: 1px solid #fff;
      margin-bottom: -1px;
      color: #007BFF;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .algorithm-info {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      border-left: 4px solid #007BFF;
    }
    .algorithm-info h4 {
      margin-top: 0;
      color: #007BFF;
    }
    .comparison-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      margin-bottom: 20px;
      transition: background 0.3s ease;
    }
    .comparison-btn:hover {
      background: #218838;
    }
    .comparison-section {
      display: none;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }
    .best-algorithm {
      background-color: #e6f7e6;
      border-left: 4px solid #28a745;
      padding: 15px;
      margin: 20px 0;
      border-radius: 4px;
    }
    .chart-row {
      display: flex;
      flex-wrap: wrap;
      margin: 0 -10px;
    }
    .chart-col {
      flex: 1;
      min-width: 300px;
      padding: 0 10px;
      margin-bottom: 20px;
    }
    
    @media (max-width: 640px) {
      body {
        margin: 10px;
      }
      h2, h3, h4 {
        margin-top: 30px;
      }
      table {
        min-width: 100%;
      }
      th, td {
        padding: 8px 10px;
        font-size: 0.9rem;
      }
      a {
        font-size: 0.95rem;
      }
      .tabs {
        flex-wrap: wrap;
      }
      .tab {
        padding: 8px 12px;
        font-size: 0.9rem;
        margin-bottom: 5px;
      }
      .chart-col {
        min-width: 100%;
      }
    }
  </style>
  
  <!-- Load Chart.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Load Plotly for additional charts -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
  <h2>Optimization Results</h2>
  
  <!-- Algorithm tabs navigation -->
  <div class="tabs" id="algorithmTabs">
    {% for algorithm, results in all_results.items %}
      <div class="tab {% if forloop.first %}active{% endif %}" data-algorithm="{{ algorithm }}">
        {{ algorithm|upper }}
      </div>
    {% endfor %}
    <button class="comparison-btn" id="showComparison">Compare All Algorithms</button>
  </div>
  
  <!-- Determine best algorithm -->
  {% with best_algo=all_results|dict_get_best_algorithm|default:all_results.items|first %}
  <div class="best-algorithm">
    <h3>Recommended Optimization</h3>
    <p>Based on performance metrics, the <strong>{{ best_algo.0|upper }}</strong> algorithm is recommended as it provides:</p>
    <ul>
      <li>{{ best_algo.1.pressure_improvement|floatformat:2 }}% pressure improvement</li>
      <li>{{ best_algo.1.cost_reduction|floatformat:2 }}% cost reduction</li>
      <li>Completed in {{ best_algo.1.execution_time|floatformat:2 }} seconds</li>
    </ul>
  </div>
  {% endwith %}
  
  <!-- Comparison section -->
  <div class="comparison-section" id="comparisonSection">
    <h3>Algorithm Comparison</h3>
    <div class="table-container">
      <table id="comparisonTable">
        <thead>
          <tr>
            <th>Metric</th>
            {% for algorithm in all_results.keys %}
              <th>{{ algorithm|upper }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Execution Time (s)</td>
            {% for algorithm, results in all_results.items %}
              <td>{{ results.execution_time|floatformat:2 }}</td>
            {% endfor %}
          </tr>
          <tr>
            <td>Pressure Improvement (%)</td>
            {% for algorithm, results in all_results.items %}
              <td>{{ results.pressure_improvement|floatformat:2 }}</td>
            {% endfor %}
          </tr>
          <tr>
            <td>Cost Reduction (%)</td>
            {% for algorithm, results in all_results.items %}
              <td>{{ results.cost_reduction|floatformat:2 }}</td>
            {% endfor %}
          </tr>
        </tbody>
      </table>
    </div>
    <div class="chart-container">
      <canvas id="comparisonChart" height="300"></canvas>
    </div>
    <div id="performanceRadarChart" class="chart-container"></div>
  </div>
  
  <!-- Tab content for each algorithm -->
  {% for algorithm, results in all_results.items %}
    <div class="tab-content {% if forloop.first %}active{% endif %}" id="{{ algorithm }}-results">
      <div class="algorithm-info">
        <h4>{{ algorithm|upper }} Optimization</h4>
        <p>Execution time: <strong>{{ results.execution_time|floatformat:2 }} seconds</strong></p>
        <p>Pressure improvement: <strong>{{ results.pressure_improvement|floatformat:2 }}%</strong></p>
        <p>Cost reduction: <strong>{{ results.cost_reduction|floatformat:2 }}%</strong></p>
      </div>
      
      <div class="chart-row">
        <div class="chart-col">
          <h4>Top 10 Nodes by Pressure</h4>
          <div class="chart-container">
            <canvas id="{{ algorithm }}-pressureBarChart" height="300"></canvas>
          </div>
        </div>
        <div class="chart-col">
          <h4>Pressure Distribution</h4>
          <div class="chart-container">
            <canvas id="{{ algorithm }}-pressurePieChart" height="300"></canvas>
          </div>
        </div>
      </div>
      
      <div class="chart-row">
        <div class="chart-col">
          <h4>Top 10 Links by Flowrate</h4>
          <div class="chart-container">
            <canvas id="{{ algorithm }}-flowrateBarChart" height="300"></canvas>
          </div>
        </div>
        <div class="chart-col">
          <h4>Flowrate Distribution</h4>
          <div class="chart-container">
            <canvas id="{{ algorithm }}-flowratePieChart" height="300"></canvas>
          </div>
        </div>
      </div>
      
      {% if results.pressure_summary %}
        <h3>Pressure Summary</h3>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Node</th>
                <th>Mean (psi)</th>
                <th>Min (psi)</th>
                <th>Max (psi)</th>
              </tr>
            </thead>
            <tbody>
              {% for node in results.pressure_summary.mean_pressure.keys %}
                <tr>
                  <td>{{ node }}</td>
                  <td>{{ results.pressure_summary.mean_pressure|get:node|floatformat:2 }}</td>
                  <td>{{ results.pressure_summary.min_pressure|get:node|floatformat:2 }}</td>
                  <td>{{ results.pressure_summary.max_pressure|get:node|floatformat:2 }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        
        <h4>Pressure Histogram</h4>
        <div class="chart-container">
          <canvas id="{{ algorithm }}-pressureHistogram" height="300"></canvas>
        </div>
      {% endif %}

      {% if results.flowrate_summary %}
        <h3>Flowrate Summary</h3>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Link</th>
                <th>Mean (m³/s)</th>
                <th>Min (m³/s)</th>
                <th>Max (m³/s)</th>
              </tr>
            </thead>
            <tbody>
              {% for link in results.flowrate_summary.mean_flowrate.keys %}
                <tr>
                  <td>{{ link }}</td>
                  <td>{{ results.flowrate_summary.mean_flowrate|get:link|floatformat:4 }}</td>
                  <td>{{ results.flowrate_summary.min_flowrate|get:link|floatformat:4 }}</td>
                  <td>{{ results.flowrate_summary.max_flowrate|get:link|floatformat:4 }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        
        <h4>Flowrate Histogram</h4>
        <div class="chart-container">
          <canvas id="{{ algorithm }}-flowrateHistogram" height="300"></canvas>
        </div>
      {% endif %}

      {% if results.demand_summary %}
        <h3>Demand Summary</h3>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Node</th>
                <th>Mean (m³/s)</th>
                <th>Min (m³/s)</th>
                <th>Max (m³/s)</th>
              </tr>
            </thead>
            <tbody>
              {% for node in results.demand_summary.mean_demand.keys %}
                <tr>
                  <td>{{ node }}</td>
                  <td>{{ results.demand_summary.mean_demand|get:node|floatformat:4 }}</td>
                  <td>{{ results.demand_summary.min_demand|get:node|floatformat:4 }}</td>
                  <td>{{ results.demand_summary.max_demand|get:node|floatformat:4 }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        
        <h4>Demand Distribution</h4>
        <div class="chart-container">
          <canvas id="{{ algorithm }}-demandPieChart" height="300"></canvas>
        </div>
      {% endif %}

      {% if results.valves %}
        <h3>Recommended Valve Locations</h3>
        <ul>
          {% for link in results.valves %}
            <li><strong>{{ link }}</strong></li>
          {% endfor %}
        </ul>
      {% endif %}

      {% if results.plots %}
        <h3>Network Visualizations</h3>
        <div class="chart-row">
          {% if results.plots.pressure %}
            <div class="chart-col">
              <h4>Pressure Map</h4>
              <img src="{{ results.plots.pressure }}" alt="Pressure Plot" loading="lazy">
            </div>
          {% endif %}
          {% if results.plots.flowrate %}
            <div class="chart-col">
              <h4>Flowrate Map</h4>
              <img src="{{ results.plots.flowrate }}" alt="Flowrate Plot" loading="lazy">
            </div>
          {% endif %}
        </div>
      {% endif %}
    </div>
  {% endfor %}

  <a href="{% url 'index' %}">← Back to Upload</a>

  <script>
    // Tab switching functionality
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        // Remove active class from all tabs and content
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        // Add active class to clicked tab and corresponding content
        tab.classList.add('active');
        const algorithm = tab.getAttribute('data-algorithm');
        document.getElementById(`${algorithm}-results`).classList.add('active');
      });
    });
    
    // Comparison button functionality
    document.getElementById('showComparison').addEventListener('click', function() {
      const comparisonSection = document.getElementById('comparisonSection');
      if (comparisonSection.style.display === 'block') {
        comparisonSection.style.display = 'none';
        this.textContent = 'Compare All Algorithms';
      } else {
        comparisonSection.style.display = 'block';
        this.textContent = 'Hide Comparison';
        renderComparisonChart();
        renderRadarChart();
      }
    });
    
    // Render charts for each algorithm
    {% for algorithm, results in all_results.items %}
      {% if results.pressure_summary %}
        // Pressure Bar Chart (Top 10 Nodes)
        const {{ algorithm }}TopPressureLabels = Object.entries({{ results.pressure_summary.mean_pressure|safe }})
          .sort((a, b) => b[1] - a[1])
          .slice(0, 10)
          .map(item => item[0]);
        const {{ algorithm }}TopPressureValues = Object.entries({{ results.pressure_summary.mean_pressure|safe }})
          .sort((a, b) => b[1] - a[1])
          .slice(0, 10)
          .map(item => item[1]);
        
        new Chart(
          document.getElementById('{{ algorithm }}-pressureBarChart').getContext('2d'), {
            type: 'bar',
            data: {
              labels: {{ algorithm }}TopPressureLabels,
              datasets: [{
                label: 'Pressure (psi)',
                data: {{ algorithm }}TopPressureValues,
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              scales: {
                y: {
                  beginAtZero: true,
                  title: { display: true, text: 'Pressure (psi)' }
                }
              }
            }
          }
        );
        
        // Pressure Pie Chart (Distribution)
        const {{ algorithm }}PressureBins = {
          '0-20 psi': Object.values({{ results.pressure_summary.mean_pressure|safe }}).filter(v => v <= 20).length,
          '20-40 psi': Object.values({{ results.pressure_summary.mean_pressure|safe }}).filter(v => v > 20 && v <= 40).length,
          '40-60 psi': Object.values({{ results.pressure_summary.mean_pressure|safe }}).filter(v => v > 40 && v <= 60).length,
          '60-80 psi': Object.values({{ results.pressure_summary.mean_pressure|safe }}).filter(v => v > 60 && v <= 80).length,
          '80+ psi': Object.values({{ results.pressure_summary.mean_pressure|safe }}).filter(v => v > 80).length
        };
        
        new Chart(
          document.getElementById('{{ algorithm }}-pressurePieChart').getContext('2d'), {
            type: 'pie',
            data: {
              labels: Object.keys({{ algorithm }}PressureBins),
              datasets: [{
                data: Object.values({{ algorithm }}PressureBins),
                backgroundColor: [
                  'rgba(255, 99, 132, 0.6)',
                  'rgba(54, 162, 235, 0.6)',
                  'rgba(255, 206, 86, 0.6)',
                  'rgba(75, 192, 192, 0.6)',
                  'rgba(153, 102, 255, 0.6)'
                ]
              }]
            }
          }
        );
        
        // Pressure Histogram
        new Chart(
          document.getElementById('{{ algorithm }}-pressureHistogram').getContext('2d'), {
            type: 'histogram',
            data: {
              datasets: [{
                label: 'Pressure Distribution',
                data: Object.values({{ results.pressure_summary.mean_pressure|safe }}),
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              scales: {
                y: { title: { display: true, text: 'Frequency' } },
                x: { title: { display: true, text: 'Pressure (psi)' } }
              }
            }
          }
        );
      {% endif %}

      {% if results.flowrate_summary %}
        // Flowrate Bar Chart (Top 10 Links)
        const {{ algorithm }}TopFlowrateLabels = Object.entries({{ results.flowrate_summary.mean_flowrate|safe }})
          .sort((a, b) => Math.abs(b[1]) - Math.abs(a[1]))
          .slice(0, 10)
          .map(item => item[0]);
        const {{ algorithm }}TopFlowrateValues = Object.entries({{ results.flowrate_summary.mean_flowrate|safe }})
          .sort((a, b) => Math.abs(b[1]) - Math.abs(a[1]))
          .slice(0, 10)
          .map(item => item[1]);
        
        new Chart(
          document.getElementById('{{ algorithm }}-flowrateBarChart').getContext('2d'), {
            type: 'bar',
            data: {
              labels: {{ algorithm }}TopFlowrateLabels,
              datasets: [{
                label: 'Flowrate (m³/s)',
                data: {{ algorithm }}TopFlowrateValues,
                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              scales: {
                y: {
                  title: { display: true, text: 'Flowrate (m³/s)' }
                }
              }
            }
          }
        );
        
        // Flowrate Pie Chart (Direction Distribution)
        const {{ algorithm }}FlowDirection = {
          'Positive Flow': Object.values({{ results.flowrate_summary.mean_flowrate|safe }}).filter(v => v > 0).length,
          'Negative Flow': Object.values({{ results.flowrate_summary.mean_flowrate|safe }}).filter(v => v < 0).length,
          'Zero Flow': Object.values({{ results.flowrate_summary.mean_flowrate|safe }}).filter(v => v === 0).length
        };
        
        new Chart(
          document.getElementById('{{ algorithm }}-flowratePieChart').getContext('2d'), {
            type: 'pie',
            data: {
              labels: Object.keys({{ algorithm }}FlowDirection),
              datasets: [{
                data: Object.values({{ algorithm }}FlowDirection),
                backgroundColor: [
                  'rgba(54, 162, 235, 0.6)',
                  'rgba(255, 99, 132, 0.6)',
                  'rgba(201, 203, 207, 0.6)'
                ]
              }]
            }
          }
        );
        
        // Flowrate Histogram
        new Chart(
          document.getElementById('{{ algorithm }}-flowrateHistogram').getContext('2d'), {
            type: 'histogram',
            data: {
              datasets: [{
                label: 'Flowrate Distribution',
                data: Object.values({{ results.flowrate_summary.mean_flowrate|safe }}),
                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              scales: {
                y: { title: { display: true, text: 'Frequency' } },
                x: { title: { display: true, text: 'Flowrate (m³/s)' } }
              }
            }
          }
        );
      {% endif %}

      {% if results.demand_summary %}
        // Demand Pie Chart
        const {{ algorithm }}DemandBins = {
          'Low Demand': Object.values({{ results.demand_summary.mean_demand|safe }}).filter(v => v <= 0.001).length,
          'Medium Demand': Object.values({{ results.demand_summary.mean_demand|safe }}).filter(v => v > 0.001 && v <= 0.005).length,
          'High Demand': Object.values({{ results.demand_summary.mean_demand|safe }}).filter(v => v > 0.005).length
        };
        
        new Chart(
          document.getElementById('{{ algorithm }}-demandPieChart').getContext('2d'), {
            type: 'pie',
            data: {
              labels: Object.keys({{ algorithm }}DemandBins),
              datasets: [{
                data: Object.values({{ algorithm }}DemandBins),
                backgroundColor: [
                  'rgba(54, 162, 235, 0.6)',
                  'rgba(255, 206, 86, 0.6)',
                  'rgba(255, 99, 132, 0.6)'
                ]
              }]
            }
          }
        );
      {% endif %}
    {% endfor %}
    
    // Render comparison chart
    function renderComparisonChart() {
      const ctx = document.getElementById('comparisonChart').getContext('2d');
      const algorithms = [{% for algorithm in all_results.keys %}'{{ algorithm|upper }}',{% endfor %}];
      const executionTimes = [{% for algorithm, results in all_results.items %}{{ results.execution_time }},{% endfor %}];
      const pressureImprovements = [{% for algorithm, results in all_results.items %}{{ results.pressure_improvement }},{% endfor %}];
      const costReductions = [{% for algorithm, results in all_results.items %}{{ results.cost_reduction }},{% endfor %}];
      
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: algorithms,
          datasets: [
            {
              label: 'Execution Time (s)',
              data: executionTimes,
              backgroundColor: 'rgba(54, 162, 235, 0.6)',
              borderColor: 'rgba(54, 162, 235, 1)',
              borderWidth: 1
            },
            {
              label: 'Pressure Improvement (%)',
              data: pressureImprovements,
              backgroundColor: 'rgba(75, 192, 192, 0.6)',
              borderColor: 'rgba(75, 192, 192, 1)',
              borderWidth: 1
            },
            {
              label: 'Cost Reduction (%)',
              data: costReductions,
              backgroundColor: 'rgba(255, 99, 132, 0.6)',
              borderColor: 'rgba(255, 99, 132, 1)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Value'
              }
            }
          }
        }
      });
    }
    
    // Render radar chart for performance comparison
    function renderRadarChart() {
      const algorithms = [{% for algorithm in all_results.keys %}'{{ algorithm|upper }}',{% endfor %}];
      const metrics = ['Execution Time', 'Pressure Improvement', 'Cost Reduction'];
      
      // Normalize data for radar chart (0-100 scale)
      const normalize = (values, inverse = false) => {
        const max = Math.max(...values);
        const min = Math.min(...values);
        return values.map(v => {
          if (max === min) return 50;
          const normalized = ((v - min) / (max - min)) * 100;
          return inverse ? 100 - normalized : normalized;
        });
      };
      
      const executionTimes = normalize([{% for algorithm, results in all_results.items %}{{ results.execution_time }},{% endfor %}], true);
      const pressureImprovements = normalize([{% for algorithm, results in all_results.items %}{{ results.pressure_improvement }},{% endfor %}]);
      const costReductions = normalize([{% for algorithm, results in all_results.items %}{{ results.cost_reduction }},{% endfor %}]);
      
      const data = algorithms.map((algo, i) => ({
        type: 'scatterpolar',
        r: [executionTimes[i], pressureImprovements[i], costReductions[i], executionTimes[i]],
        theta: metrics.concat([metrics[0]]),
        fill: 'toself',
        name: algo
      }));
      
      const layout = {
        polar: {
          radialaxis: {
            visible: true,
            range: [0, 100]
          }
        },
        showlegend: true
      };
      
      Plotly.newPlot('performanceRadarChart', data, layout);
    }
    
    // Initialize the best algorithm tab as active
    document.addEventListener('DOMContentLoaded', function() {
      const bestAlgo = '{{ best_algo.0 }}';
      if (bestAlgo) {
        document.querySelectorAll('.tab').forEach(tab => {
          tab.classList.remove('active');
          if (tab.getAttribute('data-algorithm') === bestAlgo) {
            tab.classList.add('active');
          }
        });
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
          if (content.id === `${bestAlgo}-results`) {
            content.classList.add('active');
          }
        });
      }
    });
  </script>
</body>
</html>